import nmap 
import json

class VulnScanner:
  def __init__(self):
    self.nm = nmap.PortScanner()
    self.host = "127.0.0.1"

    self.scan()
    
  def scan(self):
    self.nm.scan(self.host, "1-65535", "-sT -sV -Pn")
    ports = self.nm[self.host]['tcp'].keys()

    services_scanned = []

    for port in ports:
      state = self.nm[self.host]['tcp'][port]['state']
      service = self.nm[self.host]['tcp'][port]['name']
      product = self.nm[self.host]['tcp'][port]['product']  
      version = self.nm["127.0.0.1"]['tcp'][port]['version']

      server_used = product + " " + version
      services_scanned.append(server_used)

      print(f"port: {port} - {state} ::: {server_used}")

    for service in services_scanned:
      self.attach_to_cve(service)
      

  def attach_to_cve(self, server_used):
    with open("SimuSecApp/PythonCode/Scanners/vulns.json", "r+") as f:
      data = json.load(f)

      vuln_count = 0

      for x in range(len(data["Vulnerabilities"])):
        total_vuln = data["Vulnerabilities"][x]
        servers = total_vuln["server"]
        
        if server_used in servers:
          vuln_count += 1
          cve = total_vuln["CVE"]
          severity = total_vuln["Severity"]
          description = total_vuln["Description"]
          vuln_type = total_vuln["Type"]

          print("---------------------------------------------")
          print(f"{server_used} - Type: {vuln_type}\nCVE: {cve} - Severity: {severity}\nDescription: {description}")

if __name__ == "__main__":
  ns = VulnScanner()

    